[config]
skip_core_tasks = true

[tasks.build]
description = "Build All"
dependencies = ["build-web"]

[tasks.build-web]
dependencies = ["replace_gstatic", "copy-wasm-web"]

[tasks.replace_gstatic]
dependencies = ["download-firebasejs"]
script = [
'''
#!/usr/bin/env bash
for src in build/web/*.js
do
    dst=${src}.replaced
    cat $src | sed 's/https:\/\/www\.gstatic\.com/./g' > $dst
    mv -vf $dst $src
done
'''
]

[tasks.download-firebasejs]
dependencies = ["build-chrome_extension"]
script = [
'''
version="8.10.1"
dstdir="build/web/firebasejs/$version"
mkdir -pv $dstdir
for mod in "app" "messaging"
do
    url="https://www.gstatic.com/firebasejs/${version}/firebase-${mod}.js"
    target=$dstdir/$(basename $url)
    echo "Downloading $url -> $target"
    [ -f $target ] || curl -o $target -L $url
done
'''
]

[tasks.copy-wasm-web]
dependencies = ["build-wasm"]
script = [
'''
dir="build/web/pkg"
rm -rf $dir
mkdir -pv $dir
for ext in js wasm
do
    cp -vf wasmlib/pkg/*.$ext $dir/
done
for src in $(find $dir -name '*.js')
do
    dst=${src}.sed
    cat $src | sed 's/export default init;//' | sed 's/^export //' > $dst
    diff $src $dst || echo ''
    mv -vf $dst $src
done

src=$dir/wasmlib.js
dst=${src}.next
awk -f - $src > $dst <<'EOF'
BEGIN { PUT=0; IN=0 }
/function init/ { sub("input", ""); print $0; PUT=1; IN=1 }
/input = new URL/ { print "    input = 'pkg/wasmlib_bg.wasm';" }
/ +}$/ { if (IN == 1) { IN=0 } }
/.*/ { if (PUT == 0) { print $0 } else { if (IN == 0) { PUT=0 } } }
EOF

diff $src $dst || echo ''
mv -vf $dst $src
'''
]

[tasks.build-chrome_extension]
script = [
'''
#!/usr/bin/env bash
flutter build web --web-renderer html --csp
'''
]

[tasks.build-wasm]
script = [
'''
#!/usr/bin/env bash
pwd
ls -la

cd wasmlib
wasm-pack build --target web
'''
]
